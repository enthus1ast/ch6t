// Generated by CoffeeScript 1.11.1
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    var main, server, serverOutput;
    server = myLayout.root.getItemsById('server')[0];
    serverOutput = server.element[0].querySelector('.output');
    window.removeDoubleWhite = function(line) {
      if (line.search("  ") !== -1) {
        return removeDoubleWhite(line.replace("  ", " "));
      } else {
        return line;
      }
    };
    window.parseIncoming = function(rawline) {
      var headerPart, line, lineParts, result;
      result = {};
      headerPart = "";
      line = rawline.trim();
      if (line.startsWith(":")) {
        line = line.slice(1);
        result.who = line.split(" ")[0];
        line = line.slice(result.who.len + 1);
      }
      if (line.search(" :") !== -1) {
        result.trailer = line.split(" :").slice(1).join(" :");
        headerPart = line.split(" :")[0];
      } else {
        result.trailer = "";
        headerPart = line;
      }
      lineParts = removeDoubleWhite(headerPart).trim().split(" ");
      result.command = lineParts[1];
      result.params = lineParts.slice(2);
      result.raw = rawline;
      return result;
    };
    window.appendToRoom = function(room, ircLineIn) {
      var div, line, recvDateObj, recvTime, roomDom, roomDomOutput;
      room = "";
      recvDateObj = new Date();
      recvTime = (recvDateObj.getHours()) + ":" + (recvDateObj.getMinutes());
      line = "[" + recvTime + "] <" + ircLineIn.who + "> " + ircLineIn.trailer;
      roomDom = openChatWindow(ircLineIn.params[0]);
      div = document.createElement('div');
      div.innerText = line;
      roomDomOutput = roomDom.element[0].querySelector('.output');
      roomDomOutput.appendChild(div);
      return roomDomOutput.scrollTop = roomDomOutput.scrollHeight;
    };
    main = function(server, user, nick) {
      window.connection = new WebSocket('ws://' + server, ['irc']);
      connection.onopen = function() {
        connection.send('USER ' + user + ' * * *\n');
        connection.send('NICK ' + nick + '\n');
        connection.send('PONG :t\n');
        return connection.send('join #lobby\n');
      };
      return connection.onmessage = function(event) {
        var div, ircLineIn, pongReply;
        console.log('Server: ' + event.data);
        ircLineIn = parseIncoming(event.data);
        console.log(ircLineIn);
        div = document.createElement('div');
        div.innerText = event.data;
        serverOutput.appendChild(div);
        serverOutput.scrollTop = serverOutput.scrollHeight;
        if (event.data.startsWith("PING")) {
          console.log("send pong reply");
          pongReply = "PONG" + event.data.slice(4) + "\n";
          connection.send(pongReply);
        }
        if (ircLineIn.command === "PRIVMSG") {
          console.log("we've got privmsg");
          return appendToRoom(ircLineIn.params[0], ircLineIn);
        }
      };
    };
    return main("127.0.0.1:7787", "asd", "astoll");
  });

}).call(this);
